<style>
  .truncate-uid {
    max-width: 150px; /* Максимальная ширина ячейки */
    white-space: nowrap; /* Запрет переноса текста */
    overflow: hidden; /* Скрытие выходящего за рамки текста */
    text-overflow: ellipsis; /* Добавление многоточия */
    display: inline-block; /* Необходимо для правильной работы max-width */
  }

  #scrollToTopBtn {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 30px;
    z-index: 99;
    border: none;
    outline: none;
    background-color: #0d6efd;
    color: white;
    cursor: pointer;
    padding: 15px;
    border-radius: 10px;
    font-size: 18px;
    transition: opacity 0.3s;
  }

  #scrollToTopBtn:hover {
    background-color: #0b5ed7;
  }
</style>

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>История исследований</h1>
    <div class="btn-group">
      <%= link_to 'Загрузить новое исследование', root_path, class: 'btn btn-success' %>
      <% if @uploads.any? %>
        <%= link_to 'Выгрузить в XLSX', history_path(format: :xlsx), class: 'btn btn-secondary' %>
      <% end %>
    </div>
  </div>

  <% if @uploads.any? %>
    <div class="table-responsive">
      <table class="table table-striped mt-4">
        <thead>
          <tr>
            <th>Имя файла</th>
            <th>Дата загрузки</th>
            <th>Статус</th>
            <th scope="col">Срезы</th>
            <th scope="col">Патология</th>
            <th scope="col">Вероятность</th>
            <th scope="col">Study UID</th>
            <th scope="col">Series UID</th>
            <th scope="col">Время обработки (с)</th>
            <th scope="col">Результат</th>
          </tr>
        </thead>
        <tbody>
          <% @uploads.each do |upload| %>
            <tr>
              <td><%= upload.original_filename %></td>
              <td><%= upload.created_at.strftime('%Y-%m-%d %H:%M:%S') %></td>
              <td>
                <span class="badge bg-<%= status_badge_class(upload.status) %>">
                  <%= upload.status %>
                </span>
              </td>
              <td><%= upload.slices_processed if upload.slices_processed.present? %></td>
              <td>
                <% if upload.status == 'completed' %>
                  <%= pathology_badge(upload.pathology) %>
                <% end %>
              </td>
              <td>
                <% if upload.status == 'completed' && upload.probability_of_pathology.present? %>
                  <%= number_to_percentage(upload.probability_of_pathology * 100, precision: 2) %>
                <% end %>
              </td>
              <td title="<%= upload.study_uid %>"><div class="truncate-uid"><%= upload.study_uid %></div></td>
              <td title="<%= upload.series_uid %>"><div class="truncate-uid"><%= upload.series_uid %></div></td>
              <td><%= upload.time_of_processing %></td>
              <td>
                <% if upload.status == 'completed' && upload.result_path.present? %>
                  <%= link_to 'Смотреть', result_path(upload), class: 'btn btn-sm btn-info' %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <p class="mt-4">Вы еще не загружали ни одного исследования.</p>
  <% end %>
</div>

<button onclick="scrollToTop()" id="scrollToTopBtn" title="Наверх">&#9650;</button>

<script>
  // Получаем кнопку
  const scrollToTopBtn = document.getElementById("scrollToTopBtn");

  // Показываем кнопку, когда пользователь прокручивает страницу на 200px вниз
  window.onscroll = function() {
    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
      scrollToTopBtn.style.display = "block";
    } else {
      scrollToTopBtn.style.display = "none";
    }
  };

  // Прокручиваем страницу наверх при клике
  function scrollToTop() {
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
</script>
