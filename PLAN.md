# Итоговый отчет о разработке: Классификатор КТ-снимков

## Финальное резюме

Проект по созданию сервиса для классификации КТ-снимков успешно завершен. Мы прошли полный цикл разработки: от подготовки и анализа данных до обучения, оптимизации и финальной интеграции модели в веб-приложение.

**Ключевые достигнутые этапы:**
1.  **Подготовка данных:** Два 2D-датасета были обработаны на VPS, разделены на train/validation/test выборки с учетом группировки по пациентам для предотвращения утечки данных.
2.  **Обучение модели:** На мощном удаленном сервере с GPU была обучена модель `EfficientNet-B0` на PyTorch. Процесс включал раннюю остановку (early stopping) для эффективности.
3.  **Оценка:** Модель показала высокую производительность (F1-score ~0.97) на независимой тестовой выборке, что подтверждает ее обобщающую способность.
4.  **Оптимизация и экспорт:** Обученная модель была конвертирована в универсальный формат **ONNX** для кросс-платформенной совместимости и ускорения инференса.
5.  **Интеграция:** После серии отладочных итераций была реализована **стабильная гибридная архитектура**. Rails-приложение использует системную утилиту `dcmtk` для конвертации DICOM в PNG, а затем вызывает изолированный **Python-скрипт** для выполнения инференса на ONNX-модели. Это решение позволило обойти проблемы с Ruby-библиотеками и зависимостями.
6.  **Тестирование и развертывание:** Весь пайплайн был успешно протестирован. `Dockerfile` и `docker-compose.yml` были полностью настроены для создания самодостаточного и рабочего окружения, включающего как Ruby, так и Python со всеми зависимостями.

## История выполнения

- [x] **Фаза 1: Подготовка данных и инфраструктуры**
  - [x] Настроен VPS-сервер для скачивания и обработки больших датасетов.
  - [x] Проанализированы и скачаны датасеты: "Chest CT-Scan images" и "IQ-OTH/NCCD".
  - [x] Реализован скрипт `process_data.py` для создания `train.csv`, `validation.csv`, `test.csv` с учетом стратификации и группировки по пациентам.

- [x] **Фаза 2: Обучение и оценка модели**
  - [x] Настроен мощный сервер с GPU для обучения.
  - [x] Реализован скрипт `train.py` с использованием PyTorch, EfficientNet-B0 и Albumentations.
  - [x] Проведено обучение с ранней остановкой (patience=30), лучшая модель сохранена (`best_model.pth`).
  - [x] Реализован скрипт `evaluate.py` для честной оценки на тестовой выборке. Получен F1-score ~0.97.

- [x] **Фаза 3: Первоначальная интеграция**
  - [x] Модель экспортирована в формат `model.onnx`.
  - [x] Проанализирована архитектура Ruby on Rails приложения.
  - [x] Предпринята попытка прямой интеграции модели в `DicomProcessor` с использованием гемов `onnxruntime` и `ruby-vips`.
  - [x] Проведена отладка: заменен гем `dicom` на `ruby-dicom`.
  - [x] Подготовлены тестовые архивы для проверки end-to-end функционала.

- [x] **Фаза 4: Финальная отладка и стабилизация**
  - [x] **Проблема 1:** Прямая обработка DICOM в Ruby оказалась нестабильной (ошибки `no encode delegate`, пустые PNG-файлы).
    - **Решение:** Отказ от Ruby-библиотек для конвертации. Интегрирована системная утилита `dcmtk` (`dcm2img`), обеспечившая надежное преобразование DICOM в PNG.
  - [x] **Проблема 2:** Несовместимость версий Ruby и `bundler` заблокировала установку гема `mini_magick` для предобработки изображений перед подачей в модель.
    - **Решение:** Отказ от обработки изображений в Ruby. Логика инференса (включая resize и normalize) вынесена в отдельный **Python-скрипт** (`run_inference.py`).
  - [x] **Проблема 3:** Ошибки при вызове Python-скрипта из Docker-контейнера (`No such file or directory`).
    - **Анализ:** Конфликт между `venv`, созданным на хост-машине, и монтированием томов в Docker.
    - **Решение:** `Dockerfile` был модифицирован для создания Python `venv` и установки зависимостей **внутри образа**. `docker-compose.yml` был исправлен для корректной изоляции `venv` от локального монтирования.
  - [x] **Проблема 4:** Ошибка в Python-скрипте (`index out of bounds`).
    - **Анализ:** Неверное предположение о формате выходных данных ONNX-модели.
    - **Решение:** Исправлен парсинг результата модели в `run_inference.py`.
  - [x] **Результат:** Получен полностью рабочий и стабильный пайплайн. Все компоненты успешно протестированы.

- [x] **Фаза 5: Поддержка и улучшение**
  - [x] **Проблема 5:** Некорректный расчет вероятности (значения > 100%).
    - **Анализ:** Python-скрипт возвращал логиты модели вместо вероятностей.
    - **Решение:** В `run_inference.py` добавлена сигмоидная функция для корректного преобразования логитов в вероятности.
  - [x] **Новая фича:** Улучшена страница просмотра результатов.
    - **Реализация:** Python-скрипт теперь возвращает детальную информацию по каждому срезу. В базу данных добавлено поле `slices_data` (jsonb). Страница результатов теперь отображает все срезы, отсортированные по убыванию вероятности, с указанием индивидуальной вероятности для каждого.
  - [x] **Управление версиями:** Проект загружен в удаленный репозиторий на GitHub.

- [x] **Фаза 6: Расширение функционала (согласно ТЗ)**
  - [x] **Новая фича:** Расширен сбор данных. В модель `Upload` добавлены поля `study_uid`, `series_uid`, `time_of_processing`.
    - **Реализация:** Создана миграция базы данных. `DicomProcessor` теперь извлекает `StudyInstanceUID` и `SeriesInstanceUID` из DICOM-тегов. `DicomProcessingJob` замеряет время обработки и сохраняет все новые данные.
  - [x] **Новая фича:** Обновлен интерфейс истории исследований.
    - **Реализация:** В таблицу истории добавлены колонки для отображения `Study UID`, `Series UID` и времени обработки.
  - [x] **Новая фича:** Реализован экспорт данных в XLSX.
    - **Реализация:** Добавлена кнопка "Выгрузить в XLSX". Создан контроллер и шаблон для генерации отчета со всеми исследованиями.

- [x] **Фаза 7: Улучшение UX и масштабируемости**
  - [x] **Новая фича:** Реализована массовая загрузка исследований.
    - **Реализация:** Форма загрузки теперь позволяет выбирать несколько файлов. Контроллер был переработан для итеративной обработки массива файлов и постановки каждого в очередь Sidekiq.
  - [x] **Улучшение интерфейса:** Внесены правки для повышения удобства использования.
    - **Реализация:** Кнопки управления перенесены наверх. Длинные UID в таблице теперь сокращаются с помощью CSS. Добавлена кнопка "Наверх" для быстрой навигации.
  - [x] **Исправление формата отчета:** XLSX-отчет приведен в строгое соответствие с ТЗ.
    - **Реализация:** Переработан шаблон `history.xlsx.axlsx`, изменены заголовки, порядок колонок и формат данных.

- [x] **Фаза 8: Повышение надежности обработки данных**
  - [x] **Проблема 6:** Некоторые DICOM-файлы без расширения `.dcm` не обрабатывались.
    - **Анализ:** Система идентифицировала файлы для обработки исключительно по расширению, что приводило к пропуску валидных DICOM-файлов с другими именами.
    - **Решение:** Логика определения DICOM-файлов была полностью переработана. Вместо проверки расширения теперь используется надежный метод анализа "магического числа" (`DICM`) в заголовке файла. Это гарантирует, что любые DICOM-файлы будут корректно распознаны и обработаны независимо от их имени.
